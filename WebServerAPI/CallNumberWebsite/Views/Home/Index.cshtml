@{
    Layout = null;
}

@model CallNumberWebsite.Models.Login
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Máy gọi số</title>
    <link rel="shortcut icon" href="~/favicon.ico" />
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2018.3.911/styles/kendo.common-material.min.css" />
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2018.3.911/styles/kendo.material.min.css" />
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2018.3.911/styles/kendo.material.mobile.min.css" />
    <link href="~/Content/style.css" rel="stylesheet" />

    <script src="https://kendo.cdn.telerik.com/2018.3.911/js/jquery.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2018.3.911/js/kendo.all.min.js"></script>
</head>
<body>
    <div id="container">
        <div id="header"><div>MÁY GỌI SỐ</div></div>
        <div id="body">
            <div id="info">
                <div id="info-left">
                    <div id="time-group">Thời gian:</div>
                    <div id="quay-group">Quầy:</div>
                    <div id="id-group">Mã số:</div>
                    <div id="name-group">Họ tên:</div>
                    <div id="bo-phan-group"><span></span>Bộ phận:</div>
                </div>
                <div id="info-right">
                    <div id="time">20/10/2018</div>
                    <div id="quay">1</div>
                    <div id="id">0</div>
                    <div id="name">Nguyễn Văn B</div>
                    <div id="bo-phan">Lĩnh vực tài nguyên và đất đai, thủy văn</div>
                </div>
            </div>
            <div id="number-group">
                <div id="title">
                    <div id="title-number"><span></span>SỐ ĐANG GỌI</div>
                    <div id="number">0</div>
                </div>
                <div id="btn-group">
                    <div id="btn-next" class="k-primary">TIẾP THEO</div>
                    <div id="btn-again" class="k-primary">&nbsp; GỌI LẠI &nbsp;</div>
                    @*<div id="btn-success" class="k-primary">HOÀN TẤT</div>*@
                </div>
            </div>
        </div>
        <div id="footer">
            <div id="btn-change-pw">ĐỔI MẬT KHẨU</div>
            @Html.ActionLink("Đăng xuất", "Logout", "Login")
        </div>
    </div>
    <div id="black">
        <div id="list-view">
            <div id="grid"></div>
        </div>
        <div id="black-span"></div>
        <div id="open">Thống kê</div>
    </div>
    <div id="window">
        <label>Mật khẩu cũ: </label><div id="mk-cu"><input type="password"></div>
        <label>Mật khẩu mới: </label><div id="mk-moi1"><input type="password"></div>
        <label>Nhập lại mật khẩu: </label><div id="mk-moi2"><input type="password"></div>
        <div id="btn-change">THAY ĐỔI</div>
    </div>
</body>
</html>

<script>
    var url = window.location.origin;
    var today = new Date();
    var macb = 0;
    var mabp = 0;
    var mamay = 0;
    var mastt = 0;
    var madn = 0;
    var dd = today.getDate();
    var mm = today.getMonth() + 1; //January is 0!
    var yyyy = today.getFullYear();
    if (dd < 10) { dd = '0' + dd }
    if (mm < 10) { mm = '0' + mm }
    today = dd + '/' + mm + '/' + yyyy;
    $("#time").text(today)

    // Lấy thông tin cán bộ
    function getInfo() {
        $.ajax({
            url: url + "/Home/GetInfo",
            type: "GET",
            dataType: "json",
            success: function (result) {
                var js = JSON.parse(result);
                macb = js["MaCB"];
                mabp = js["MaBP"];
                mamay = js["MaMay"];
                madn = js["MaDN"];
                $("#id").text(js["MaCB"]);
                $("#name").text(js["HoTen"]);
                $("#bo-phan").text(js["TenBP"]);
                $("#bo-phan-group span").prop("id", js["MaBP"]);
                saveInfo();
                //getNumber();
            },
            error: function (xhr) {
                console.log(xhr.responseText);
            }
        })
    }
    // Lưu lại các thông tin
    function saveInfo() {
        $.ajax({
            url: url + "/Home/SaveInfo",
            type: "GET",
            dataType: "json",
            data: { "_MaBP": mabp, "_MaCB": macb, "_MaMay": mamay, "_MaDN": madn },
            success: function (result) {
            },
            error: function (xhr) {
                console.log(xhr.responseText);
            }
        })
    }
    // Lấy số trước khi refresh trang
    function getNumber() {
        $.ajax({
            url: url + "/Home/GetNumber",
            type: "GET",
            dataType: "json",
            data: { "_MaCB": macb },
            success: function (result) {
                $("#number").text(result);
            },
            error: function (xhr) {
                console.log(xhr.responseText);
            }
        })
    }
    // Lưu số đã gọi trước đó
    function saveNumber(mastt) {
        $.ajax({
            url: url + "/Home/SaveNumber",
            type: "GET",
            dataType: "json",
            data: { "_MaSTT": mastt },
            success: function (result) {
            },
            error: function (xhr) {
                console.log(xhr.responseText);
            }
        })
    }

    // Tạo cửa sổ đổi mật khẩu
    $("#window").kendoWindow({ title: "ĐỔI MẬT KHẨU" });
    // Tạo sự kiện đóng cửa sổ tự động khi load trang
    $("#window").data("kendoWindow").close();
    // Tạo sự kiện nút tiếp theo
    $("#btn-next").kendoButton();
    $("#btn-next").click(function () {
        if (macb != 0 && mabp != 0) {
            $.ajax({
                url: url + "/Home/CallNumber",
                type: "POST",
                dataType: "json",
                data: { "_MaCB": macb, "_MaBP": mabp },
                success: function (result) {
                    var js = JSON.parse(result);
                    if (result == false) {
                        alert("Hết số thứ tự để gọi");
                    } else {
                        mastt = js["MaSTT"];
                        $("#number").text(js["STT"]);
                        $("#title-number span").prop("id", js["MaSTT"]);
                    }
                    //saveNumber(js["MaSTT"]);
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                }
            })
        }
    })
    // Tạo sự kiện nút gọi lại =================================================
    $("#btn-again").kendoButton();
    $("#btn-again").click(function () {
        // Gọi lại
    })
    // Tạo sự kiện nút mở cửa sổ đổi mật khẩu
    $("#btn-change-pw").kendoButton();
    $("#btn-change-pw").click(function () {
        $("#window").data("kendoWindow").open();
        //$("#btn-change-pw").fadeOut();
    })
    // Tạo sự kiện nút đổi mật khẩu
    $("#btn-change").kendoButton();
    $("#btn-change").click(function () {
        var mkcu = $("#mk-cu input").val();
        var mkmoi1 = $("#mk-moi1 input").val();
        var mkmoi2 = $("#mk-moi2 input").val();
        if (mkcu.length == 0 || mkmoi1.length == 0 || mkmoi2.length == 0) { alert("Vui lòng điền đầy đủ mật khẩu") }
        else if (mkcu == mkmoi1) { alert("Mật khẩu mới không được trùng với mật khẩu cũ") }
        else if (mkmoi1 != mkmoi2) { alert("Mật khẩu nhập lại không đúng") }
        else {
            $.ajax({
                url: url + "/Home/ChangePW",
                type: "GET",
                dataType: "json",
                data: { "_MKCu": mkcu, "_MKMoi": mkmoi1 },
                success: function (result) {
                    if (result == true) { alert("Thay đổi thành công"); }
                    else { alert("Thay đổi không thành công"); }
                },
                error: function (xhr) { console.log(xhr.responseText); }
            })
        }
    })
    // Tạo sự kiện nút đăng xuất
    $("a[href$='/Login/Logout']").kendoButton()
    // Tạo bảng thời gian các phiên làm việc ====================================
    $("#grid").kendoGrid({
        dataSource: {
            type: "odata",
            transport: {
                read: "https://demos.telerik.com/kendo-ui/service/Northwind.svc/Orders"
            },
            schema: {
                model: {
                    fields: {
                        OrderID: { type: "number" },
                        Freight: { type: "number" },
                        ShipName: { type: "string" },
                        OrderDate: { type: "date" },
                        ShipCity: { type: "string" }
                    }
                }
            },
            pageSize: 20,
            serverPaging: true,
            serverFiltering: true,
            serverSorting: true
        },
        filterable: true,
        sortable: true,
        pageable: true,
        columns: [{
            field: "OrderID",
            filterable: false,
            width: 1
        },
        {
            field: "OrderDate",
            title: "Order Date",
            format: "{0:MM/dd/yyyy}",
            width: 2
        }
        ]
    });
    // Tạo sự kiện nút mở rộng bảng thống kê
    $("#open").click(function () {
        $('#grid').data('kendoGrid').dataSource.read();
        $("#black")[0].classList.toggle("move-right");
    })
    // Tạo sự kiện thu nhỏ bảng thống kê khi click vào mảng đen mờ
    $("#black-span").click(function () {
        console.log("click");
        $("#black")[0].classList.remove("move-right")
    })

    $(document).ready(function () {
        getInfo();
    })
</script>

<style>
    div#btn-next {
        /* position: absolute; */
        /* top: 30%; */
        /* left: 44%; */
        /* transform: translate(-50%,-50%); */
    }

    div#grid {
        font-size: 0.8em;
        height: 100%;
    }

    div.k-grid-footer, div.k-grid-header {
        height: 10%;
    }

    .k-grid-content.k-auto-scrollable.km-widget.km-native-scroller {
        height: 80%;
    }

    .k-edge .k-pager-wrap, .k-ff .k-pager-wrap, .k-ie11 .k-pager-wrap, .k-safari .k-pager-wrap, .k-webkit .k-pager-wrap {
        height: 10%;
    }

    #window {
        font-size: 1.2em;
    }

    #mk-cu input, #mk-moi1 input, #mk-moi2 input {
        float: right;
        font-size: 1.2em;
    }
</style>